## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
library("ibmWatsonStudioLib")
wslib <- access_project_or_space()
print("watsonlib loaded")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
library(nnet)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
#csv <- capture.output(write.csv(iris, row.names=FALSE), type="output")
#csv_raw <- charToRaw(paste0(csv, collapse='\n'))
#wslib$save_data("input.csv", csv_raw)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
input_file <- Sys.getenv('input_file_name')


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
input_file <- gsub("\"", "", input_file)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
print(input_file)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# read data
my_file <- wslib$load_data(input_file)
df <-  read.csv(text = rawToChar(my_file))
head(df)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
wslib$download_file("preprocess_data.R")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
source("preprocess_data.R")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
df_processed <- preprocess_data(df, "Species")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
head(df_processed)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
wslib$download_file("model.rds")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
load_model <- readRDS("model.rds")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
load_model


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
colnames(df_processed) <- c('Sepal.L.','Sepal.W.','Petal.L.','Petal.W.','species')


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
final_predictions <- predict(load_model, df_processed[1:5,])


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
final_predictions


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
csv <- capture.output(write.csv(final_predictions, row.names=FALSE), type="output")
csv_raw <- charToRaw(paste0(csv, collapse='\n'))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
file_name <- paste0(strftime(Sys.time()), ".csv")
file_name <- gsub(":", "-", file_name)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
wslib$save_data(file_name, csv_raw)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------


